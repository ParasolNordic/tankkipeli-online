<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Star Wars Space Battle</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #000000;
            font-family: 'Arial', sans-serif;
            color: #FFE81F;
            overflow: hidden;
            background-image: radial-gradient(2px 2px at 20% 30%, white, transparent),
                              radial-gradient(2px 2px at 60% 70%, white, transparent),
                              radial-gradient(1px 1px at 50% 50%, white, transparent);
            background-size: 200px 200px;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* HERÃ„TYSVIESTI TYYLIT */
        #wakeupScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            display: none;
        }
        
        #wakeupScreen.show {
            display: flex;
        }
        
        .wakeup-spinner {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 232, 31, 0.1);
            border-top: 8px solid #FFE81F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .wakeup-message {
            font-size: 24px;
            color: #FFE81F;
            margin-bottom: 20px;
            text-align: center;
            padding: 0 20px;
            text-shadow: 0 0 10px rgba(255, 232, 31, 0.5);
        }
        
        .wakeup-timer {
            font-size: 48px;
            color: #4169E1;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(65, 105, 225, 0.8);
        }
        
        .wakeup-subtitle {
            font-size: 16px;
            color: #888;
            text-align: center;
            max-width: 400px;
            line-height: 1.5;
        }
        
        /* MENU TYYLIT */
        .menu-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }
        
        .menu-screen.show {
            display: flex;
        }
        
        .menu-title {
            font-size: 42px;
            margin-bottom: 30px;
            color: #FFE81F;
            text-shadow: 0 0 30px rgba(255, 232, 31, 0.8),
                         0 0 60px rgba(255, 232, 31, 0.4);
            font-weight: bold;
            letter-spacing: 4px;
        }
        
        .star-wars-logo {
            font-size: 56px;
            color: #FFE81F;
            text-shadow: 0 0 30px rgba(255, 232, 31, 0.8);
            margin-bottom: 10px;
            font-weight: bold;
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: 20px;
            color: #4169E1;
            text-shadow: 0 0 10px rgba(65, 105, 225, 0.6);
            margin-bottom: 40px;
            letter-spacing: 3px;
        }
        
        .menu-btn {
            font-size: 20px;
            padding: 15px 30px;
            cursor: pointer;
            color: #000;
            border: 3px solid #FFE81F;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 232, 31, 0.4),
                        inset 0 0 10px rgba(255, 232, 31, 0.2);
            margin: 10px;
            transition: all 0.3s;
            background: linear-gradient(135deg, #FFE81F, #FFC800);
        }
        
        .menu-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 232, 31, 0.8),
                        inset 0 0 20px rgba(255, 232, 31, 0.3);
        }
        
        .menu-btn:active {
            transform: scale(0.95);
        }
        
        .menu-btn.secondary {
            background: linear-gradient(135deg, #4169E1, #1E3A8A);
            border-color: #4169E1;
            color: #fff;
            box-shadow: 0 0 20px rgba(65, 105, 225, 0.4);
        }
        
        .menu-btn.back {
            background: #333;
            border-color: #666;
            color: #fff;
            box-shadow: none;
        }
        
        #qrcode {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 0 30px rgba(255, 232, 31, 0.3);
        }
        
        #roomCode {
            font-size: 48px;
            font-weight: bold;
            color: #FFE81F;
            letter-spacing: 15px;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(255, 232, 31, 0.6);
        }
        
        #status {
            color: #4169E1;
            margin: 15px 0;
            font-size: 18px;
            text-shadow: 0 0 10px rgba(65, 105, 225, 0.5);
        }
        
        .code-input {
            padding: 15px;
            font-size: 32px;
            width: 250px;
            text-align: center;
            border: 3px solid #FFE81F;
            border-radius: 10px;
            margin: 20px 0;
            text-transform: uppercase;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background: #1a1a1a;
            color: #FFE81F;
            box-shadow: 0 0 20px rgba(255, 232, 31, 0.3);
        }
        
        /* PELI TYYLIT */
        #gameContainer {
            display: none;
            width: 100%;
            height: 100vh;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 160px;
        }
        
        #gameContainer.show {
            display: flex;
        }
        
        #gameWrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #info {
            padding: 5px 10px;
            text-align: center;
            background: rgba(0, 0, 0, 0.9);
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #FFE81F;
            border-radius: 5px;
        }
        
        #scores {
            display: flex;
            gap: 30px;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }
        
        .player1-score { 
            color: #ffffff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        .player2-score { 
            color: #708090;
            text-shadow: 0 0 10px rgba(112, 128, 144, 0.5);
        }
        .player3-score { 
            color: #9e9e9e;
            text-shadow: 0 0 10px rgba(158, 158, 158, 0.5);
        }
        
        #gameCanvas {
            background: #000;
            display: block;
            border: 3px solid #FFE81F;
            box-shadow: 0 0 30px rgba(255, 232, 31, 0.3);
        }
        
        #message {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            text-align: center;
            font-size: 18px;
            color: #FFE81F;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 5px;
            z-index: 100;
            border: 2px solid #FFE81F;
            text-shadow: 0 0 10px rgba(255, 232, 31, 0.6);
        }
        
        /* OHJAIMET */
        #controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(0, 0, 0, 0.9);
            gap: 10px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            align-items: center;
        }
        
        .dpad-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            max-width: 200px;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            border: 2px solid #fff;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
            cursor: pointer;
        }
        
        .control-btn:active {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .control-btn.empty {
            visibility: hidden;
        }
        
        .shoot-btn {
            width: 60px;
            height: 60px;
            border: 3px solid #fff;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            touch-action: none;
            cursor: pointer;
            grid-column: 2;
            grid-row: 2;
        }
    </style>
</head>
<body>
    <!-- HERÃ„TYSVIESTI -->
    <div id="wakeupScreen">
        <div class="wakeup-spinner"></div>
        <div class="wakeup-message">Activating hyperdrive...</div>
        <div class="wakeup-timer" id="wakeupTimer">30</div>
        <div class="wakeup-subtitle">
            The server is waking up from standby mode.<br>
            This takes about 30 seconds on first connection.
        </div>
    </div>

    <!-- PÃ„Ã„VALIKKO -->
    <div id="mainMenu" class="menu-screen show">
        <div class="star-wars-logo">â˜… STAR WARS â˜…</div>
        <div class="subtitle">SPACE BATTLE</div>
        <div id="status">Connecting to battle station...</div>
        <div id="mainButtons" style="display:none;">
            <button class="menu-btn" onclick="showCreateMenu()">
                ğŸš€ CREATE BATTLE
            </button>
            <button class="menu-btn secondary" onclick="showJoinMenu()">
                ğŸ¯ JOIN BATTLE
            </button>
        </div>
    </div>

    <!-- LUO PELI MENU -->
    <div id="createMenu" class="menu-screen">
        <div class="menu-title">SELECT SQUADRON SIZE</div>
        <div style="display:flex; gap:20px; flex-wrap:wrap; justify-content:center;">
            <button class="menu-btn" onclick="selectPlayers(2)">
                2 PILOTS
            </button>
            <button class="menu-btn secondary" onclick="selectPlayers(3)">
                3 PILOTS
            </button>
        </div>
        <button class="menu-btn back" style="margin-top:30px;" onclick="backToMain()">
            â† BACK
        </button>
    </div>

    <!-- AMMUKSET VALINTA -->
    <div id="bounceMenu" class="menu-screen">
        <div class="menu-title">LASER MODE</div>
        <div style="display:flex; gap:20px; flex-wrap:wrap; justify-content:center;">
            <button class="menu-btn" onclick="createGame(true)">
                âš¡ RICOCHETING
            </button>
            <button class="menu-btn secondary" onclick="createGame(false)">
                ğŸ¯ DIRECT FIRE
            </button>
        </div>
        <button class="menu-btn back" style="margin-top:30px;" onclick="backToCreate()">
            â† BACK
        </button>
    </div>

    <!-- ODOTETAAN PELAAJIA -->
    <div id="waitingRoom" class="menu-screen">
        <div class="menu-title">AWAITING PILOTS</div>
        <div id="roomCode"></div>
        <div id="qrcode"></div>
        <div id="waitingStatus" style="margin-top:20px; font-size:18px; color:#FFE81F;"></div>
        <p style="margin-top:20px; color:#888;">
            Other pilots can scan the QR code<br>
            or enter the code in the join menu
        </p>
    </div>

    <!-- LIITY PELIIN -->
    <div id="joinMenu" class="menu-screen">
        <div class="menu-title">JOIN BATTLE</div>
        <p style="margin-bottom:20px; color:#888;">Enter the 4-character battle code:</p>
        <input type="text" id="codeInput" class="code-input" placeholder="XXXX" maxlength="4">
        <button class="menu-btn" onclick="joinGame()">
            JOIN
        </button>
        <button class="menu-btn back" style="margin-top:20px;" onclick="backToMain()">
            â† BACK
        </button>
    </div>

    <!-- PELINÃ„KYMÃ„ -->
    <div id="gameContainer">
        <div id="gameWrapper">
            <canvas id="gameCanvas"></canvas>
            
            <div id="info">
                <div id="scores">
                    <div class="player1-score">X-Wing: <span id="score-p1">0</span></div>
                    <div class="player2-score">TIE Fighter: <span id="score-p2">0</span></div>
                    <div class="player3-score" id="p3ScoreContainer" style="display:none;">
                        Falcon: <span id="score-p3">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="message"></div>
        
        <div id="controls" style="display:none;">
            <!-- Ohjaimet generoidaan JavaScriptillÃ¤ -->
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PALVELINYHTEYS JA HERÃ„TYSVIESTI
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const SERVER_URL = window.location.origin;
        let socket = null;
        let isConnected = false;
        let wakeupStartTime = null;
        
        function showWakeupScreen() {
            document.getElementById('wakeupScreen').classList.add('show');
            wakeupStartTime = Date.now();
            updateWakeupTimer();
        }
        
        function hideWakeupScreen() {
            document.getElementById('wakeupScreen').classList.remove('show');
        }
        
        function updateWakeupTimer() {
            if (!wakeupStartTime) return;
            
            const elapsed = Math.floor((Date.now() - wakeupStartTime) / 1000);
            const remaining = Math.max(0, 30 - elapsed);
            
            document.getElementById('wakeupTimer').textContent = remaining;
            
            if (isConnected) {
                hideWakeupScreen();
            } else if (remaining > 0) {
                requestAnimationFrame(updateWakeupTimer);
            }
        }
        
        function connectToServer() {
            showWakeupScreen();
            document.getElementById('status').textContent = 'Connecting to battle station...';
            
            socket = io(SERVER_URL, {
                transports: ['websocket', 'polling'],
                timeout: 20000,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 10,
                debug: true,
                forceNew: true
            });
            
            socket.onAny((eventName, ...args) => {
                console.log(`ğŸ“¥ SOCKET EVENT: ${eventName}`, args);
            });
            
            socket.on('connect', () => {
                console.log('âœ… Connected to battle station!');
                console.log('ğŸ†” Socket ID:', socket.id);
                isConnected = true;
                hideWakeupScreen();
                document.getElementById('status').textContent = 'Ready for combat! Select mode.';
                document.getElementById('mainButtons').style.display = 'block';
                
                console.log('ğŸ“ Calling setupGameEvents()...');
                setupGameEvents();
                console.log('âœ… setupGameEvents() completed!');
            });
            
            socket.on('serverAwake', (data) => {
                console.log('ğŸŸ¢ Server is awake:', data);
                isConnected = true;
                hideWakeupScreen();
            });
            
            socket.on('disconnect', () => {
                console.log('âŒ Connection lost');
                isConnected = false;
                document.getElementById('status').textContent = 'Connection lost. Reconnecting...';
            });
            
            socket.on('connect_error', (error) => {
                console.log('âš ï¸ Connection error:', error);
                document.getElementById('status').textContent = 'Waking up server, please wait...';
            });
            
            socket.on('error', (data) => {
                alert(data.message);
            });
        }
        
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const joinCode = urlParams.get('join');
            
            connectToServer();
            
            if (joinCode) {
                setTimeout(() => {
                    document.getElementById('codeInput').value = joinCode.toUpperCase();
                    showJoinMenu();
                    setTimeout(joinGame, 1000);
                }, 2000);
            }
        });
        
        function setupGameEvents() {
            console.log('ğŸ”§ Registering game events...');
            
            socket.on('playerJoined', (data) => {
                console.log('ğŸ‘¥ EVENT: playerJoined', data);
                updateWaitingStatus(data.totalPlayers, gameSettings.playerCount);
            });
            
            socket.on('allPlayersJoined', () => {
                console.log('âœ…âœ…âœ… EVENT RECEIVED: allPlayersJoined!');
                document.getElementById('waitingStatus').textContent = 'All pilots ready! Starting battle...';
                setTimeout(() => {
                    console.log('ğŸ® CALLING startGame()!');
                    startGame();
                }, 2000);
            });
            
            console.log('âœ… allPlayersJoined event registered!');
            
            socket.on('gameCreated', (data) => {
                currentRoomCode = data.roomCode;
                myPlayerNumber = data.playerNumber;
                
                console.log('âœ… Battle created:', currentRoomCode);
                
                hideAllMenus();
                document.getElementById('waitingRoom').classList.add('show');
                document.getElementById('roomCode').textContent = currentRoomCode;
                
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = '';
                const url = window.location.origin + window.location.pathname + '?join=' + currentRoomCode;
                new QRCode(qrContainer, {
                    text: url,
                    width: 200,
                    height: 200
                });
                
                updateWaitingStatus(1, gameSettings.playerCount);
            });
            
            socket.on('gameJoined', (data) => {
                myPlayerNumber = data.playerNumber;
                gameSettings = {
                    playerCount: data.gameState.playerCount,
                    bounceEnabled: data.gameState.bounceEnabled
                };
                
                console.log('âœ… Joined battle. Pilot #', myPlayerNumber);
                
                hideAllMenus();
                document.getElementById('waitingRoom').classList.add('show');
                document.getElementById('roomCode').textContent = currentRoomCode;
                document.getElementById('qrcode').style.display = 'none';
                
                updateWaitingStatus(myPlayerNumber, gameSettings.playerCount);
            });
            
            socket.on('playerLeft', (data) => {
                document.getElementById('message').textContent = `Pilot ${data.playerNumber} left the battle`;
            });
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VALIKKOLOGIIKKA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function hideAllMenus() {
            document.querySelectorAll('.menu-screen').forEach(menu => {
                menu.classList.remove('show');
            });
        }
        
        function showMainMenu() {
            hideAllMenus();
            document.getElementById('mainMenu').classList.add('show');
        }
        
        function showCreateMenu() {
            hideAllMenus();
            document.getElementById('createMenu').classList.add('show');
        }
        
        function showJoinMenu() {
            hideAllMenus();
            document.getElementById('joinMenu').classList.add('show');
        }
        
        function backToMain() {
            showMainMenu();
        }
        
        function backToCreate() {
            hideAllMenus();
            document.getElementById('createMenu').classList.add('show');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PELIN LUONTI JA LIITTYMINEN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let selectedPlayerCount = 2;
        let myPlayerNumber = 0;
        let currentRoomCode = '';
        let isHost = false;
        let gameSettings = {
            playerCount: 2,
            bounceEnabled: false
        };
        
        function selectPlayers(count) {
            selectedPlayerCount = count;
            gameSettings.playerCount = count;
            hideAllMenus();
            document.getElementById('bounceMenu').classList.add('show');
        }
        
        function createGame(bounceEnabled) {
            gameSettings.bounceEnabled = bounceEnabled;
            isHost = true;
            
            console.log('ğŸ® Creating battle:', gameSettings);
            socket.emit('createGame', gameSettings);
        }
        
        function joinGame() {
            const code = document.getElementById('codeInput').value.trim().toUpperCase();
            
            if (code.length !== 4) {
                alert('Enter 4-character code!');
                return;
            }
            
            isHost = false;
            currentRoomCode = code;
            
            console.log('ğŸ”Œ Joining battle:', code);
            socket.emit('joinGame', code);
        }
        
        function updateWaitingStatus(current, total) {
            const status = document.getElementById('waitingStatus');
            status.textContent = `Pilots ready: ${current}/${total}`;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PELIN ALUSTUS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function startGame() {
            hideAllMenus();
            document.getElementById('gameContainer').classList.add('show');
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            if (gameSettings.playerCount === 3) {
                document.getElementById('p3ScoreContainer').style.display = 'block';
            }
            
            console.log('ğŸ“¡ Registering game socket events...');
            if (typeof setupGameSocketEvents === 'function') {
                setupGameSocketEvents();
            } else {
                console.error('âŒ setupGameSocketEvents not defined!');
            }
            
            // Alusta peli
            initGame(myPlayerNumber, gameSettings.playerCount, gameSettings.bounceEnabled);
            
            console.log('ğŸ® Battle begins! Pilot #' + myPlayerNumber);
            document.getElementById('message').textContent = 'Battle begins!';
        }
        
        function resizeCanvas() {
            const GAME_WIDTH = 1000;
            const GAME_HEIGHT = 550;
            
            canvas.width = GAME_WIDTH;
            canvas.height = GAME_HEIGHT;
        }
        
        function createControls() {
            // Ohjaimet luodaan game.js:ssÃ¤
        }
        
        console.log('ğŸš€ Star Wars Space Battle main program loaded!');
    </script>
    <script src="game.js"></script>
</body>
</html>
